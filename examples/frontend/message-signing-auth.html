<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Message Signing Authentication - Prompt Mining</title>

  <!-- Load ethers.js v6 from CDN -->
  <script src="https://unpkg.com/ethers@6.7.1/dist/ethers.umd.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .info-box {
      background: #e8f5e9;
      border: 1px solid #4caf50;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 25px;
      font-size: 13px;
      color: #2e7d32;
    }

    .info-box strong {
      display: block;
      margin-bottom: 5px;
    }

    .info-box ul {
      margin-top: 8px;
      margin-left: 20px;
    }

    .config-note {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 25px;
      font-size: 13px;
      color: #856404;
    }

    .section {
      margin-bottom: 25px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #11998e;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(17, 153, 142, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }

    .status.info {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      color: #1565c0;
      display: block;
    }

    .status.success {
      background: #e8f5e9;
      border: 1px solid #4caf50;
      color: #2e7d32;
      display: block;
    }

    .status.error {
      background: #ffebee;
      border: 1px solid #f44336;
      color: #c62828;
      display: block;
    }

    .status.loading {
      background: #fff3e0;
      border: 1px solid #ff9800;
      color: #e65100;
      display: block;
    }

    .wallet-info {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
    }

    .wallet-info .address {
      font-family: 'Courier New', monospace;
      color: #11998e;
      word-break: break-all;
      font-weight: 600;
    }

    .auth-status {
      background: #e8f5e9;
      border: 1px solid #4caf50;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      display: none;
    }

    .auth-status.authenticated {
      display: block;
    }

    .tx-link {
      color: #11998e;
      text-decoration: none;
      font-weight: 600;
    }

    .tx-link:hover {
      text-decoration: underline;
    }

    .loader {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #ff9800;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .code-block {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
      margin-top: 10px;
      word-break: break-all;
    }

    .flow-diagram {
      background: #f5f5f5;
      border-left: 4px solid #11998e;
      padding: 15px;
      margin: 20px 0;
      font-size: 13px;
      line-height: 1.8;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê Message Signing Authentication</h1>
    <p class="subtitle">Authenticate with Metamask and submit prompts (company-sponsored mode)</p>

    <div class="info-box">
      <strong>‚ú® What's Different About This Flow?</strong>
      <ul>
        <li><strong>You sign a MESSAGE</strong> (free, no gas fees)</li>
        <li><strong>Your company pays gas</strong> for the blockchain transaction</li>
        <li><strong>Users get rewarded</strong> without needing gas tokens</li>
        <li><strong>Perfect for onboarding</strong> non-Web3 users</li>
      </ul>
    </div>

    <div class="flow-diagram">
      <strong>Flow:</strong><br>
      1Ô∏è‚É£ User signs message with Metamask (proves wallet ownership)<br>
      2Ô∏è‚É£ Backend verifies signature<br>
      3Ô∏è‚É£ Backend submits transaction (company pays gas)<br>
      4Ô∏è‚É£ User receives Activity Points
    </div>

    <div class="config-note">
      <strong>‚ö†Ô∏è Configuration Required</strong>
      Update the CONFIG section in this file with your backend API URL.
    </div>

    <!-- Wallet Connection -->
    <div class="section">
      <button id="connectBtn" onclick="connectWallet()">Connect Metamask</button>
    </div>

    <div id="walletInfo" class="wallet-info" style="display: none;">
      <div><strong>Connected Address:</strong></div>
      <div class="address" id="walletAddress"></div>
    </div>

    <!-- Authentication Section -->
    <div class="section" id="authSection" style="display: none;">
      <button id="authBtn" onclick="authenticateWallet()">
        Authenticate Wallet (Sign Message)
      </button>
      <p style="color: #666; font-size: 12px; margin-top: 8px;">
        This will prompt you to sign a message to prove wallet ownership. <strong>No gas fees!</strong>
      </p>
    </div>

    <div id="authStatus" class="auth-status">
      ‚úÖ <strong>Authenticated</strong> - Your wallet ownership is verified
    </div>

    <!-- Prompt Input -->
    <div class="section" id="promptSection" style="display: none;">
      <label for="promptInput">Your Prompt</label>
      <textarea
        id="promptInput"
        placeholder="Enter your prompt here... e.g., 'Explain quantum computing'"
      ></textarea>
    </div>

    <div class="section" id="rewardSection" style="display: none;">
      <label for="rewardInput">Activity Points Reward</label>
      <input
        type="number"
        id="rewardInput"
        placeholder="10"
        value="10"
        min="1"
      />
      <small style="color: #666; display: block; margin-top: 5px;">
        In production, this would be calculated by your backend based on prompt quality
      </small>
    </div>

    <!-- Submit Button -->
    <div class="section" id="submitSection" style="display: none;">
      <button id="submitBtn" onclick="submitPrompt()">
        Submit Prompt (Company Pays Gas)
      </button>
    </div>

    <!-- Status Messages -->
    <div id="status" class="status"></div>
  </div>

  <script>
    /**
     * ========================================
     * CONFIGURATION
     * ========================================
     */
    const CONFIG = {
      // Your backend API URL
      BACKEND_API_URL: 'http://localhost:3000',

      // Optional: API key for backend authentication
      API_KEY: '', // Leave empty if not using authentication

      // Chain ID (72080 = Nexera testnet, 7208 = Nexera mainnet)
      CHAIN_ID: 72080,

      // Block explorer URL for transaction links
      BLOCK_EXPLORER_URL: 'https://explorer.testnet.nexera.network',

      // Service name for authentication message
      SERVICE_NAME: 'Prompt Mining Service'
    };

    // Global state
    let provider = null;
    let signer = null;
    let userAddress = null;
    let authSignature = null;
    let authMessage = null;
    let authTimestamp = null;

    /**
     * Connect to Metamask wallet
     *
     * This function checks if Metamask is installed and requests account access.
     * No network switching or transaction signing happens here.
     */
    async function connectWallet() {
      try {
        showStatus('Connecting to Metamask...', 'loading');

        // Check if Metamask is installed
        console.log('Checking for Metamask... window.ethereum:', typeof window.ethereum);
        if (typeof window.ethereum === 'undefined') {
          console.error('Metamask not detected. window.ethereum is undefined');
          throw new Error('Metamask is not installed. Please install it from https://metamask.io');
        }

        console.log('Metamask detected! Provider:', window.ethereum);

        // Create ethers provider from Metamask
        provider = new ethers.BrowserProvider(window.ethereum);

        // Request account access
        await provider.send("eth_requestAccounts", []);

        // Get the signer (wallet)
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();

        // Update UI
        document.getElementById('walletAddress').textContent = userAddress;
        document.getElementById('walletInfo').style.display = 'block';
        document.getElementById('authSection').style.display = 'block';
        document.getElementById('connectBtn').textContent = 'Connected ‚úì';
        document.getElementById('connectBtn').disabled = true;

        showStatus(`Connected! Now authenticate your wallet by signing a message.`, 'info');

      } catch (error) {
        console.error('Connection error:', error);
        showStatus(`Connection failed: ${error.message}`, 'error');
      }
    }

    /**
     * Authenticate wallet by signing a message
     *
     * This function:
     * 1. Creates a message for the user to sign
     * 2. User signs the message with Metamask (FREE - no gas!)
     * 3. Stores the signature for later use
     *
     * The signed message proves the user owns the wallet address.
     * This signature will be sent to the backend for verification.
     */
    async function authenticateWallet() {
      try {
        showStatus('Preparing authentication message...', 'loading');

        // Create authentication message with timestamp
        authTimestamp = Date.now();
        authMessage = `Welcome to ${CONFIG.SERVICE_NAME}!\n\n` +
          `Please sign this message to authenticate your wallet.\n\n` +
          `Address: ${userAddress}\n` +
          `Timestamp: ${authTimestamp}\n\n` +
          `This request will not trigger any blockchain transaction or cost any gas fees.`;

        showStatus('Please sign the message in Metamask...', 'loading');

        // Request signature from user (NO GAS FEES)
        authSignature = await signer.signMessage(authMessage);

        console.log('Message signed:', {
          message: authMessage,
          signature: authSignature,
          address: userAddress
        });

        // Update UI to show authentication success
        document.getElementById('authStatus').classList.add('authenticated');
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('promptSection').style.display = 'block';
        document.getElementById('rewardSection').style.display = 'block';
        document.getElementById('submitSection').style.display = 'block';

        showStatus(
          `‚úÖ Authentication successful! Your signature:<br>` +
          `<div class="code-block">${authSignature.substring(0, 50)}...</div><br>` +
          `You can now submit prompts without paying gas fees.`,
          'success'
        );

      } catch (error) {
        console.error('Authentication error:', error);

        let errorMessage = error.message;
        if (error.code === 'ACTION_REJECTED') {
          errorMessage = 'Message signing was rejected. Please try again.';
        }

        showStatus(`‚ùå Authentication failed: ${errorMessage}`, 'error');
      }
    }

    /**
     * Submit prompt to backend (company-sponsored mode)
     *
     * This function:
     * 1. Sends the prompt + signed message to backend
     * 2. Backend verifies the signature to confirm wallet ownership
     * 3. Backend mints the prompt using company's wallet (company pays gas)
     * 4. User receives Activity Points without paying anything
     *
     * This is the "company-sponsored" mode from the architecture.
     */
    async function submitPrompt() {
      try {
        // Validate inputs
        const prompt = document.getElementById('promptInput').value.trim();
        const activityPoints = document.getElementById('rewardInput').value;

        if (!prompt) {
          throw new Error('Please enter a prompt');
        }

        if (!activityPoints || activityPoints <= 0) {
          throw new Error('Please enter a valid reward amount');
        }

        if (!authSignature) {
          throw new Error('Please authenticate your wallet first');
        }

        showStatus('Step 1/3: Sending prompt and authentication to backend...', 'loading');

        // Send to backend for verification and sponsored minting
        // The backend will:
        // 1. Verify the signature matches the address
        // 2. Hash the prompt locally
        // 3. Request PZERO authorization (hash only)
        // 4. Sign and submit the transaction (company's wallet)
        // 5. Return transaction details
        const response = await fetch(`${CONFIG.BACKEND_API_URL}/api/prompts/mint-sponsored`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(CONFIG.API_KEY && { 'x-api-key': CONFIG.API_KEY })
          },
          body: JSON.stringify({
            prompt,
            author: userAddress,
            activityPoints,
            // Include authentication proof
            authentication: {
              message: authMessage,
              signature: authSignature,
              timestamp: authTimestamp
            }
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Backend error: ${response.status}`);
        }

        showStatus('Step 2/3: Backend is submitting transaction...', 'loading');

        const result = await response.json();
        console.log('Mint result:', result);

        showStatus('Step 3/3: Transaction confirmed!', 'loading');

        // Extract transaction details
        const { transactionHash, promptHash, blockNumber } = result.data;

        // Show success
        const explorerUrl = `${CONFIG.BLOCK_EXPLORER_URL}/tx/${transactionHash}`;
        showStatus(
          `‚úÖ Prompt minted successfully!<br><br>` +
          `<strong>Transaction Hash:</strong><br>` +
          `<a href="${explorerUrl}" target="_blank" class="tx-link">${transactionHash}</a><br><br>` +
          `<strong>Prompt Hash:</strong><br>` +
          `<div class="code-block">${promptHash}</div><br>` +
          `<strong>Block Number:</strong> ${blockNumber}<br>` +
          `<strong>Rewards:</strong> ${activityPoints} Activity Points<br><br>` +
          `<em>‚ú® You didn't pay any gas fees! Your company sponsored this transaction.</em>`,
          'success'
        );

        // Reset form
        document.getElementById('promptInput').value = '';
        document.getElementById('rewardInput').value = '10';

      } catch (error) {
        console.error('Submission error:', error);

        let errorMessage = error.message;

        // Handle specific error cases
        if (error.message.includes('Invalid signature')) {
          errorMessage = 'Authentication signature is invalid. Please re-authenticate.';
          // Reset authentication
          authSignature = null;
          document.getElementById('authStatus').classList.remove('authenticated');
          document.getElementById('authSection').style.display = 'block';
          document.getElementById('promptSection').style.display = 'none';
          document.getElementById('submitSection').style.display = 'none';
        } else if (error.message.includes('Signature expired')) {
          errorMessage = 'Your authentication has expired. Please sign a new message.';
          // Reset authentication
          authSignature = null;
          document.getElementById('authStatus').classList.remove('authenticated');
          document.getElementById('authSection').style.display = 'block';
        }

        showStatus(`‚ùå Error: ${errorMessage}`, 'error');
      }
    }

    /**
     * Display status message to user
     *
     * @param {string} message - Message to display (can include HTML)
     * @param {string} type - Type of message: 'info', 'success', 'error', 'loading'
     */
    function showStatus(message, type) {
      const statusEl = document.getElementById('status');
      statusEl.className = `status ${type}`;

      if (type === 'loading') {
        statusEl.innerHTML = `<span class="loader"></span>${message}`;
      } else {
        statusEl.innerHTML = message;
      }
    }

    /**
     * Listen for account changes in Metamask
     */
    if (typeof window.ethereum !== 'undefined') {
      window.ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length === 0 || accounts[0] !== userAddress) {
          // User disconnected or switched account - reload page
          location.reload();
        }
      });

      window.ethereum.on('chainChanged', () => {
        // User switched network - reload page
        location.reload();
      });
    }

    // Show info on load
    window.addEventListener('load', () => {
      showStatus(
        'üëã Connect your Metamask wallet to get started. ' +
        'This flow uses message signing (no gas fees for you!)',
        'info'
      );
    });
  </script>
</body>
</html>
