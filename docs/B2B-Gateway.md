# PZERO B2B Gateway API Reference

This document describes the PZERO Gateway API that this boilerplate integrates with. The PZERO Gateway is a **separate service operated by PZERO** (not part of this boilerplate) that provides authorization and usage tracking for prompt mining deployments.

## Overview

The PZERO Gateway enables B2B customers (companies deploying this boilerplate) to:
- Authorize prompt minting operations without sharing prompt content
- Track usage and quotas per customer tier
- Enforce business rules and access control
- Generate billing metrics

## Privacy Architecture

**Critical Privacy Guarantee**: PZERO Gateway NEVER receives full prompt text.

```
Company Boilerplate               PZERO Gateway
─────────────────────            ──────────────
1. Hash prompt locally
   hash = keccak256(prompt)

2. Request authorization   ────→  3. Validate API key
   POST /v1/authorize/mint        4. Check quota
   Body: { promptHash }           5. Generate signature

6. Receive signature      ←────  7. Return authorization
   { signature, nonce }

8. Mint to blockchain
   (full prompt + signature)
```

## Base URL

```
Production: https://api.pzero.io/v1
Sandbox:    https://sandbox.api.pzero.io/v1
```

## Authentication

All requests require authentication via API key in the header:

```http
x-pzero-api-key: pzero_live_xxxxxxxxxxxxx
x-pzero-client-id: your-company-id
```

API Keys:
- **Live keys**: Start with `pzero_live_`
- **Test keys**: Start with `pzero_test_`

## Endpoints

### 1. Authorize Mint

Request authorization to mint a prompt.

**Endpoint**: `POST /v1/authorize/mint`

**Headers**:
```
Content-Type: application/json
x-pzero-api-key: pzero_live_xxxxxxxxxxxxx
x-pzero-client-id: your-company-id
```

**Request Body**:
```json
{
  "promptHash": "0x1234567890abcdef...",
  "author": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb1",
  "activityPoints": "10",
  "chainId": "1",
  "timestamp": 1234567890
}
```

**Privacy Note**: Only `promptHash` is sent, NEVER the full prompt text.

**Response** (200 OK):
```json
{
  "success": true,
  "authorization": {
    "signature": "0xabcdef1234567890...",
    "nonce": "0x9876543210...",
    "expiresAt": 1234567990
  },
  "quota": {
    "used": 125,
    "limit": 10000,
    "tier": "pro",
    "resetAt": 1234999999
  }
}
```

**Errors**:

- **402 Payment Required** - Quota exceeded
  ```json
  {
    "success": false,
    "error": {
      "code": "QUOTA_EXCEEDED",
      "message": "Monthly quota of 10,000 mints exceeded",
      "quota": {
        "used": 10000,
        "limit": 10000,
        "resetAt": 1234999999
      }
    }
  }
  ```

- **401 Unauthorized** - Invalid API key
  ```json
  {
    "success": false,
    "error": {
      "code": "INVALID_API_KEY",
      "message": "Invalid or expired API key"
    }
  }
  ```

- **403 Forbidden** - Tier restrictions
  ```json
  {
    "success": false,
    "error": {
      "code": "TIER_RESTRICTED",
      "message": "Feature not available in current tier",
      "tier": "free",
      "requiredTier": "pro"
    }
  }
  ```

### 2. Authorize Migration

Request authorization to migrate a prompt.

**Endpoint**: `POST /v1/authorize/migrate`

**Request Body**:
```json
{
  "promptHash": "0x1234567890abcdef...",
  "newDataPoint": "0x...",
  "newPromptMinerAddress": "0x...",
  "chainId": "1",
  "timestamp": 1234567890
}
```

**Response**: Same structure as authorize mint

### 3. Get Quota Status

Check current quota usage.

**Endpoint**: `GET /v1/quota`

**Response**:
```json
{
  "success": true,
  "quota": {
    "used": 125,
    "limit": 10000,
    "tier": "pro",
    "resetAt": 1234999999,
    "period": "monthly"
  }
}
```

### 4. Health Check

Check PZERO Gateway availability.

**Endpoint**: `GET /v1/health`

**Response**:
```json
{
  "status": "healthy",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

## Authorization Signature

The authorization signature is generated by PZERO and must be included when minting to the blockchain.

**Signature Generation** (PZERO side):
```
message = keccak256(abi.encodePacked(
  promptHash,
  author,
  activityPoints,
  nonce,
  expiresAt,
  chainId
))

signature = sign(message, PZERO_PRIVATE_KEY)
```

**Smart Contract Verification**:
The smart contract verifies the signature was signed by PZERO's authorized signer address.

## Error Codes

| Code | HTTP Status | Description |
|------|-------------|-------------|
| `INVALID_API_KEY` | 401 | API key is invalid or expired |
| `QUOTA_EXCEEDED` | 402 | Monthly quota limit reached |
| `TIER_RESTRICTED` | 403 | Feature requires higher tier |
| `INVALID_REQUEST` | 400 | Malformed request body |
| `RATE_LIMITED` | 429 | Too many requests |
| `INTERNAL_ERROR` | 500 | PZERO service error |
| `SERVICE_UNAVAILABLE` | 503 | PZERO temporarily unavailable |

## Rate Limits

Per API key:
- **Free**: 10 requests/minute
- **Starter**: 60 requests/minute
- **Pro**: 300 requests/minute
- **Enterprise**: Custom limits

Rate limit headers:
```
X-RateLimit-Limit: 300
X-RateLimit-Remaining: 299
X-RateLimit-Reset: 1234567890
```

## Customer Tiers

| Tier | Monthly Mints | Rate Limit | Features |
|------|---------------|------------|----------|
| Free | 1,000 | 10/min | Basic minting |
| Starter | 10,000 | 60/min | Migration support |
| Pro | 100,000 | 300/min | Analytics dashboard |
| Enterprise | Custom | Custom | Dedicated support, SLA |

## Webhooks (Future)

PZERO will send webhook events for:
- Quota warnings (80%, 90%, 100%)
- Tier upgrades/downgrades
- Unusual activity detection

**Webhook Endpoint** (configured in PZERO dashboard):
```
POST https://your-company.com/webhooks/pzero
```

## Event Monitoring

PZERO monitors blockchain events to track usage:

**Events Monitored**:
- `PromptMinted(address indexed author, bytes32 indexed promptHash, ...)`
- `PromptMigrated(bytes32 indexed promptHash, address indexed newMiner, ...)`

**What PZERO Sees** (from blockchain events):
- Transaction hash
- Block number
- Author address
- Prompt hash
- Activity points awarded
- Timestamp

**What PZERO NEVER Sees**:
- Full prompt text (privacy guaranteed)
- User PII not on-chain
- Internal company data

## Support & Documentation

- **Dashboard**: https://dashboard.pzero.io
- **API Status**: https://status.pzero.io
- **Documentation**: https://docs.pzero.io
- **Support**: support@pzero.io

## Implementation Notes

### For Boilerplate Developers

When integrating with PZERO Gateway:

1. **Always hash prompts locally** before sending to PZERO
2. **Never log full prompts** in PZERO-related code
3. **Handle quota exceeded** gracefully (inform user to upgrade)
4. **Retry on 503** with exponential backoff
5. **Cache quota status** to reduce API calls
6. **Validate signature expiry** before blockchain mint

### Security Best Practices

- Store `PM_PZERO_API_KEY` securely (environment variable, secrets manager)
- Rotate API keys regularly
- Monitor for unauthorized usage
- Use test keys in development
- Validate all responses from PZERO
- Implement timeout handling (default: 5 seconds)

## Changelog

### v1.0.0 (Current)
- Initial API release
- Mint authorization endpoint
- Migration authorization endpoint
- Quota management
- Tier-based rate limiting

### Future (Planned)
- Webhook notifications
- Advanced analytics API
- Multi-chain support
- Batch authorization requests
